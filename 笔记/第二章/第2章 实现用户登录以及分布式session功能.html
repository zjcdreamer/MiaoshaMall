<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601967 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 14pt;
    }
  </style>
</head>
<body>
<a name="2384"/>

<div>
<span><div><div><span style="font-size: 24pt; font-weight: bold;">一、两次MD5</span></div><hr/><div>1）做两次MD5加密的原因：</div><div>    a.第一次做MD5是因为HTTP是明文传输的，为了保护密码的安全所以做MD5加密</div><div>    b.防止数据库被盗，用户数据被盗用</div><div>2）导入MD5的maven依赖</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;dependency&gt;</div><div>    &lt;groupId&gt;commons-codec&lt;/groupId&gt;</div><div>    &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;</div><div>&lt;/dependency&gt;</div><div>&lt;dependency&gt;</div><div>    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</div><div>    &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;</div><div>    &lt;version&gt;3.6&lt;/version&gt;</div><div>&lt;/dependency&gt;</div></div><div><br/></div><div><br/></div><div><span style="font-size: 24pt; font-weight: bold;">二、登录功能的实现</span></div><hr/><div><br/></div><div><img src="第2章 实现用户登录以及分布式session功能_files/Image.png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><b><font style="font-size: 12pt;">loginController类</font></b></span></div><div>package com.imooc.miaosha.controller;</div><div><br/></div><div><br/></div><div>import com.imooc.miaosha.domain.User;</div><div>import com.imooc.miaosha.redis.RedisService;</div><div>import com.imooc.miaosha.redis.UserKey;</div><div>import com.imooc.miaosha.result.CodeMsg;</div><div>import com.imooc.miaosha.result.Result;</div><div>import com.imooc.miaosha.service.MiaoShaUserService;</div><div>import com.imooc.miaosha.service.UserService;</div><div>import com.imooc.miaosha.util.ValidatorUtil;</div><div>import com.imooc.miaosha.vo.LoginVo;</div><div>import org.slf4j.Logger;</div><div>import org.slf4j.LoggerFactory;</div><div>import org.springframework.beans.factory.annotation.Autowired;</div><div>import org.springframework.stereotype.Controller;</div><div>import org.springframework.ui.Model;</div><div>import org.springframework.web.bind.annotation.RequestMapping;</div><div>import org.springframework.web.bind.annotation.ResponseBody;</div><div>import org.thymeleaf.util.StringUtils;</div><div><br/></div><div><br/></div><div>import javax.servlet.http.HttpServletResponse;</div><div><br/></div><div><br/></div><div>@Controller</div><div>@RequestMapping(&quot;/login&quot;)</div><div>public class LoginController {</div><div><br/></div><div><br/></div><div>    private static Logger log = LoggerFactory.getLogger(LoginController.class);</div><div><br/></div><div><br/></div><div>    @Autowired</div><div>    UserService userService;</div><div><br/></div><div><br/></div><div>    @Autowired</div><div>    MiaoShaUserService miaoShaUserService;</div><div><br/></div><div><br/></div><div>    @Autowired</div><div>    RedisService redisService;</div><div><br/></div><div><br/></div><div>    @RequestMapping(&quot;/to_login&quot;)</div><div>    public String toLogin(){</div><div>        return &quot;login&quot;;</div><div>    }</div><div><br/></div><div><br/></div><div>    @RequestMapping(&quot;/do_login&quot;)</div><div>    @ResponseBody</div><div>    public Result&lt;Boolean&gt; doLogin(LoginVo loginVo) {</div><div>        String mobile = loginVo.getMobile();</div><div>        String password = loginVo.getPassword();</div><div>        //检查手机号是否为空</div><div>        if(StringUtils.isEmpty(mobile)){</div><div>            return Result.error(CodeMsg.MOBILE_EMPTY);</div><div>        }</div><div>        //检验密码是否为空</div><div>        if(StringUtils.isEmpty(password)){</div><div>            return Result.error(CodeMsg.PASSWORD_EMPTY);</div><div>        }</div><div>        //检验手机格式是否正确</div><div>        if(!ValidatorUtil.isMobile(mobile)){</div><div>            return Result.error(CodeMsg.MOBILE_ERROR);</div><div>        }</div><div>        //登录</div><div>        CodeMsg cm = miaoShaUserService.login(loginVo);</div><div>        if(cm.getCode() == 0){</div><div>            return Result.success(true);</div><div>        }else {</div><div>            return Result.error(cm);</div><div>        }</div><div>    }</div><div>}</div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><b><font style="font-size: 11pt;">ValidatorUtil类</font></b></div><div>package com.imooc.miaosha.util;</div><div><br/></div><div><br/></div><div>import org.thymeleaf.util.StringUtils;</div><div><br/></div><div><br/></div><div>import java.util.regex.Matcher;</div><div>import java.util.regex.Pattern;</div><div><br/></div><div><br/></div><div>public class ValidatorUtil {</div><div>    public static final Pattern mobile_pattern = Pattern.compile(&quot;1\\d{10}&quot;);</div><div><br/></div><div><br/></div><div>    public static boolean isMobile(String str){</div><div>        if(StringUtils.isEmpty(str))</div><div>            return false;</div><div><br/></div><div><br/></div><div>        Matcher m = mobile_pattern.matcher(str);</div><div>        return m.matches();</div><div>    }</div><div>}</div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><b><font style="font-size: 11pt;">miaoShaUserService类</font></b></div><div>package com.imooc.miaosha.service;</div><div><br/></div><div><br/></div><div>import com.imooc.miaosha.dao.MiaoShaUserDAO;</div><div>import com.imooc.miaosha.domain.MiaoShaUser;</div><div>import com.imooc.miaosha.result.CodeMsg;</div><div>import com.imooc.miaosha.result.Result;</div><div>import com.imooc.miaosha.util.MD5Util;</div><div>import com.imooc.miaosha.vo.LoginVo;</div><div>import org.springframework.beans.factory.annotation.Autowired;</div><div>import org.springframework.stereotype.Service;</div><div><br/></div><div><br/></div><div>@Service</div><div>public class MiaoShaUserService {</div><div><br/></div><div><br/></div><div>    @Autowired</div><div>    MiaoShaUserDAO miaoShaUserDAO;</div><div><br/></div><div><br/></div><div>    public CodeMsg login(LoginVo loginVo){</div><div>        if (loginVo == null)</div><div>            return CodeMsg.SERVER_ERROR;</div><div><br/></div><div>        MiaoShaUser miaoShaUser = miaoShaUserDAO.getUserById(Long.parseLong(loginVo.getMobile()));</div><div>        if (miaoShaUser == null)</div><div>            return CodeMsg.MOBILE_NOT_EXIST;</div><div>        String dbpassword = miaoShaUser.getPassword();</div><div>        String salt = miaoShaUser.getSalt();</div><div>        String formPass = loginVo.getPassword();</div><div>        String calPass = MD5Util.formPassToDBPass(formPass, salt);</div><div>        if(!dbpassword.equals(calPass))</div><div>            return CodeMsg.PASSWORD_ERROR;</div><div>        return CodeMsg.SUCCESS;</div><div>    }</div><div>}</div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><b><font style="font-size: 11pt;">miaoShaUserDAO类</font></b></div><div>package com.imooc.miaosha.dao;</div><div><br/></div><div>import com.imooc.miaosha.domain.MiaoShaUser;</div><div>import org.apache.ibatis.annotations.Mapper;</div><div>import org.apache.ibatis.annotations.Param;</div><div>import org.apache.ibatis.annotations.Select;</div><div><br/></div><div>@Mapper</div><div>public interface MiaoShaUserDAO {</div><div><br/></div><div><br/></div><div>    @Select(&quot;select * from miaosha_user where id = #{id}&quot;)</div><div>    public MiaoShaUser getUserById(@Param(&quot;id&quot;) Long id);</div><div>}</div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><b><font style="font-size: 11pt;">loginVo类 //用该类承接前端页面传送来的mobile和进行一次MD5加密的password</font></b></div><div>package com.imooc.miaosha.vo;</div><div><br/></div><div><br/></div><div>public class LoginVo {</div><div><br/></div><div><br/></div><div>    public String mobile;</div><div>    public String password;</div><div><br/></div><div><br/></div><div>    public String getMobile() {</div><div>        return mobile;</div><div>    }</div><div><br/></div><div><br/></div><div>    public void setMobile(String mobile) {</div><div>        this.mobile = mobile;</div><div>    }</div><div><br/></div><div><br/></div><div>    public String getPassword() {</div><div>        return password;</div><div>    }</div><div><br/></div><div><br/></div><div>    public void setPassword(String password) {</div><div>        this.password = password;</div><div>    }</div><div><br/></div><div><br/></div><div>    @Override</div><div>    public String toString() {</div><div>        return &quot;LoginVo{&quot; +</div><div>                &quot;mobile='&quot; + mobile + '\'' +</div><div>                &quot;, password='&quot; + password + '\'' +</div><div>                '}';</div><div>    }</div><div>}</div></div><div><br/></div><div><br/></div><div><span style="font-size: 24pt; font-weight: bold;">三、JSR303参数校验+异常处理</span></div><hr/><div><br/></div><div>1）导入JSR303的依赖</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;dependency&gt;</div><div>     &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>     &lt;artifactId&gt;spring-boot-starter-validation&lt;/artifactId&gt;</div><div>   &lt;/dependency&gt;</div></div><div><br/></div><div>2）对loginController类的doLogin方法的参数标注@Valid</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>public Result&lt;Boolean&gt; doLogin(<b><font style="font-size: 11pt;">@Valid</font></b> LoginVo loginVo) {}</div><div><br/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">@Valid是：</span></div></div><div><br/></div><div>3）对LoginVo类中需要校验的字段进行校验标注</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.imooc.miaosha.vo;</div><div><br/></div><div><br/></div><div>import com.imooc.miaosha.validator.isMobile;</div><div>import org.hibernate.validator.constraints.Length;</div><div><br/></div><div><br/></div><div>import javax.validation.constraints.NotNull;</div><div><br/></div><div><br/></div><div>public class LoginVo {</div><div><br/></div><div>   <b><font style="font-size: 10pt;"> @NotNull</font></b></div><div><b><font style="font-size: 10pt;">    @isMobile //这个是要自己实现的校验器</font></b></div><div>    public String mobile;</div><div><br/></div><div><br/></div><div>   <b><font style="font-size: 10pt;"> @NotNull</font></b></div><div><b><font style="font-size: 10pt;">    @Length(min = 32)</font></b></div><div>    public String password;</div><div><br/></div><div><br/></div><div>    public String getMobile() {</div><div>        return mobile;</div><div>    }</div><div><br/></div><div><br/></div><div>    public void setMobile(String mobile) {</div><div>        this.mobile = mobile;</div><div>    }</div><div><br/></div><div><br/></div><div>    public String getPassword() {</div><div>        return password;</div><div>    }</div><div><br/></div><div><br/></div><div>    public void setPassword(String password) {</div><div>        this.password = password;</div><div>    }</div><div><br/></div><div><br/></div><div>    @Override</div><div>    public String toString() {</div><div>        return &quot;LoginVo{&quot; +</div><div>                &quot;mobile='&quot; + mobile + '\'' +</div><div>                &quot;, password='&quot; + password + '\'' +</div><div>                '}';</div><div>    }</div><div>}</div></div><div><br/></div><div>4）自定义校验器：isMobile、isMobileValidator</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.imooc.miaosha.validator;</div><div><br/></div><div><br/></div><div>import javax.validation.Constraint;</div><div>import javax.validation.Payload;</div><div>import java.lang.annotation.Documented;</div><div>import java.lang.annotation.Retention;</div><div>import java.lang.annotation.Target;</div><div><br/></div><div><br/></div><div>import static java.lang.annotation.ElementType.*;</div><div>import static java.lang.annotation.ElementType.PARAMETER;</div><div>import static java.lang.annotation.ElementType.TYPE_USE;</div><div>import static java.lang.annotation.RetentionPolicy.RUNTIME;</div><div><br/></div><div><br/></div><div><b><font style="font-size: 11pt;">@Target({ METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER, TYPE_USE })</font></b></div><div><b><font style="font-size: 11pt;">@Retention(RUNTIME)</font></b></div><div><b><font style="font-size: 11pt;">@Documented</font></b></div><div><b><font style="font-size: 11pt;">@Constraint(validatedBy = {<font color="#E30000">isMobileValidator.class</font>}) //这里是写自己实际进行校验的类</font></b></div><div>public <b><font style="font-size: 11pt;">@interface</font></b> isMobile {</div><div><br/></div><div><br/></div><div>   <b><font style="font-size: 11pt;"> boolean required() default true;</font></b></div><div><br/></div><div><br/></div><div>    String message() default &quot;手机格式错误&quot;;</div><div><br/></div><div><br/></div><div>    Class&lt;?&gt;[] groups() default { };</div><div><br/></div><div><br/></div><div>    Class&lt;? extends Payload&gt;[] payload() default { };</div><div>}</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>package com.imooc.miaosha.validator;</div><div><br/></div><div><br/></div><div>import com.imooc.miaosha.util.ValidatorUtil;</div><div>import org.thymeleaf.util.StringUtils;</div><div><br/></div><div><br/></div><div>import javax.validation.ConstraintValidator;</div><div>import javax.validation.ConstraintValidatorContext;</div><div>import java.lang.annotation.Annotation;</div><div><br/></div><div><br/></div><div>public class <b>isMobileValidator</b> implements <b><font style="font-size: 10pt;">ConstraintValidator</font><font><span style="font-size: 10pt;">&lt;isMobile, Stri</span><font style="font-size: 10pt;">ng</font></font><font style="font-size: 10pt;">&gt;</font></b> {</div><div><br/></div><div>    boolean required = false;</div><div><br/></div><div>    @Override</div><div>    public void initialize(isMobile constraintAnnotation) {</div><div>        required = constraintAnnotation.required();</div><div>    }</div><div><br/></div><div>    @Override</div><div>    public boolean isValid(String value, ConstraintValidatorContext context) {</div><div>        if (required){</div><div>            return ValidatorUtil.isMobile(value);</div><div>        }else {</div><div>            if (StringUtils.isEmpty(value)){</div><div>                return true;</div><div>            }else {</div><div>                return ValidatorUtil.isMobile(value);</div><div>            }</div><div>        }</div><div>    }</div><div>}</div></div><div><br/></div><div>自定义校验器的方法：</div><ul><li><div>自定义校验器的时候可以参考其他给出的校验器的源码，类上面那些注解基本都是需要的（不需要<span style="font-size: 14pt;">@Repeatable(List.class) 这个注解)，此外方法内的default信息也是需要的。</span></div></li><li><div>首先写一个isMobile类，使用@interface。<span style="font-size: 11pt; font-weight: bold;">@Constraint(validatedBy = {</span><span style="font-size: 11pt; color: rgb(227, 0, 0); font-weight: bold;">isMobileValidator.class</span><span style="font-size: 11pt; font-weight: bold;">})</span> <span style="font-size: 14pt;">这里填写实现了ConstraintValidator&lt;A extends Annotation, T&gt;的类。然后写入boolean required() default true信息和其他的默认信息。</span></div></li><li><div>编写isMobileValidator类，该类实现<span style="font-size: 14pt;">ConstraintValidator&lt;A extends Annotation, T&gt;。A就是isMobile这个继承了</span><span style="font-size: 14pt;">Annotation的类，T就是校验数据的类型即为String。然后进行初始化方法的编写，在这里就是看require是否为true。然后在校验方法内根据require是否为true来进行业务逻辑的编写。</span></div></li></ul><div><br/></div><div>5）定义一个ExceptionHandler类</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.imooc.miaosha.exception;</div><div><br/></div><div>import com.imooc.miaosha.result.CodeMsg;</div><div>import com.imooc.miaosha.result.Result;</div><div>import org.springframework.validation.ObjectError;</div><div>import org.springframework.web.bind.annotation.ControllerAdvice;</div><div>import org.springframework.web.bind.annotation.ExceptionHandler;</div><div>import org.springframework.web.bind.annotation.ResponseBody;</div><div>import org.springframework.validation.BindException;</div><div><br/></div><div>import javax.servlet.http.HttpServletRequest;</div><div>import java.util.List;</div><div><br/></div><div><b><font style="font-size: 11pt;">@ControllerAdvice</font></b></div><div>@ResponseBody</div><div>public class GlobalExceptionHandler {</div><div><br/></div><div>    <b><font style="font-size: 11pt;">@ExceptionHandler(value = Exception.class) //这里标注的是该方法处理哪种异常</font></b></div><div>    public Result&lt;String&gt; exceptionHandler(HttpServletRequest request, Exception e){</div><div>        e.printStackTrace();</div><div>        if (e <b><font style="font-size: 10pt;">instanceof</font></b> BindException){</div><div>            BindException be = (BindException)e;</div><div>            List&lt;ObjectError&gt; allErrors = be.getAllErrors();</div><div>            ObjectError objectError = allErrors.get(0);</div><div>            String msg = objectError.getDefaultMessage();</div><div>            return Result.error(CodeMsg.BIND_ERROR.fillArgs(msg));</div><div>        }else if (e instanceof GlobalException){</div><div>            GlobalException ge = (GlobalException) e;</div><div>            return Result.error(((GlobalException) e).getCm());</div><div>        }else {</div><div>            return Result.error(CodeMsg.SERVER_ERROR);</div><div>        }</div><div>    }</div><div>}</div></div><div><br/></div><div>6）定义全局异常</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.imooc.miaosha.exception;</div><div><br/></div><div>import com.imooc.miaosha.result.CodeMsg;</div><div><br/></div><div>public class GlobalException <b><font style="font-size: 10pt;">extends RuntimeException</font></b>{</div><div><br/></div><div>    private CodeMsg cm;</div><div><br/></div><div>    public GlobalException(CodeMsg cm){</div><div>        super(cm.toString());</div><div>        this.cm = cm;</div><div>    }</div><div><br/></div><div>    public CodeMsg getCm() {</div><div>        return cm;</div><div>    }</div><div>}</div></div><div><br/></div><div>7）对MiaoShaUserService类的内容进行修改，将原先返回值改为抛出异常</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>public boolean login(LoginVo loginVo){</div><div>    if (loginVo == null)</div><div>        throw new GlobalException(CodeMsg.SERVER_ERROR);</div><div><br/></div><div><br/></div><div>    MiaoShaUser miaoShaUser = miaoShaUserDAO.getUserById(Long.parseLong(loginVo.getMobile()));</div><div>    if (miaoShaUser == null)</div><div>        throw new GlobalException(CodeMsg.MOBILE_NOT_EXIST);</div><div>    String dbpassword = miaoShaUser.getPassword();</div><div>    String salt = miaoShaUser.getSalt();</div><div>    String formPass = loginVo.getPassword();</div><div>    String calPass = MD5Util.formPassToDBPass(formPass, salt);</div><div>    if(!dbpassword.equals(calPass))</div><div>        throw new GlobalException(CodeMsg.PASSWORD_ERROR);</div><div>    return true;</div></div><div><br/></div><div>刚学到的知识点总结：</div><ul><li><div>Object.. objects 这种参数形式是在不确定方法参数的情况下定义的。可以传入任意多个参数，在方法内部把objects作为数组，使用objects[i]来访问某个元素</div></li><li><div>String.format()方法： <a href="https://blog.csdn.net/anita9999/article/details/82346552">https://blog.csdn.net/anita9999/article/details/82346552</a></div></li><li><div>instanceof：判断某个实例是否是某个类，如果是就返回true，否则返回false。</div></li><li><div>@interface：自定义注解， <span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 14pt; font-variant-caps: normal; font-variant-ligatures: common-ligatures;">自动继承了java.lang.annotation.Annotation接口。</span></span> <span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14pt; font-variant-caps: normal; font-variant-ligatures: common-ligatures;">其中的每一个方法实际上是声明了一个配置参数。方法的名称就是参数的名称，返回值类型就是参数的类型。</span> <span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14pt; font-variant-caps: normal; font-variant-ligatures: common-ligatures;">可以通过default来声明参数的默认值</span><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: common-ligatures;">。</span> <span style="font-size: 12pt;"><a href="https://blog.csdn.net/m0_37190495/article/details/83009901" style="font-size: 12pt; font-family: &quot;Microsoft YaHei&quot;;">https://blog.csdn.net/m0_37190495/article/details/83009901</a></span> <span style="font-size: 12pt;"><a href="https://www.jianshu.com/p/47834f36c2d1" style="font-size: 12pt; font-family: &quot;Microsoft YaHei&quot;;">https://www.jianshu.com/p/47834f36c2d1</a></span></div></li><li><div><span style="font-size: 14pt;">@Constraint：</span> @Constraint(<span style="font-size: 14pt;">validatedBy ={XXX}</span>)  这里写的是对该注解类进行校验的类。实际进行检验的类要实现<span style="font-size: 14pt;">ConstraintValidator&lt;A extends Annotation,T  data&gt;第一个写注解类，第二个写要校验参数的类型</span> <a href="https://blog.csdn.net/lwg_1540652358/article/details/84193759">https://blog.csdn.net/lwg_1540652358/article/details/84193759</a></div></li><li><div>@Anotation： <a href="https://blog.csdn.net/lixiaoxiong55/article/details/81435829">https://blog.csdn.net/lixiaoxiong55/article/details/81435829</a></div></li><li><div>@Valid：该注解直接标注在需要校验的变量前，然后对该变量的某些属性进行注解校验。 <a href="https://blog.csdn.net/weixin_38118016/article/details/80977207">https://blog.csdn.net/weixin_38118016/article/details/80977207</a></div></li><li><div>@ControllerAdvice： <a href="https://www.cnblogs.com/lenve/p/10748453.html">https://www.cnblogs.com/lenve/p/10748453.html</a> <a href="https://blog.csdn.net/qq_21492635/article/details/89381204">https://blog.csdn.net/qq_21492635/article/details/89381204</a></div></li><li><div>给包命名： <a href="https://blog.csdn.net/u011870547/article/details/81077153">https://blog.csdn.net/u011870547/article/details/81077153</a></div></li></ul><div><br/></div><div>异常处理 还没看</div><div><a href="https://www.cnblogs.com/lvbinbin2yujie/p/10574812.html#type2">https://www.cnblogs.com/lvbinbin2yujie/p/10574812.html#type2</a></div><div><a href="https://blog.csdn.net/kavito/article/details/81253317">https://blog.csdn.net/kavito/article/details/81253317</a></div><div><br/></div><div>要明白SpringBoot的异常处理流程和机制</div><div><br/></div><div><br/></div><div><span style="font-size: 24pt; font-weight: bold;">四、分布式session</span></div><hr/><div>背景：为了均衡服务器的访问流量，所以将请求分发到不同的服务器上。为了保证数据的一致性，服务器的数据要同步，如果通过使得每台服务器具有相同的内容，这样性能会很低。因此使用redis做分布式session</div><div><br/></div><div>1）编写一个UUIDUtil类，使用uuid来自动生成token</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.imooc.miaosha.util;</div><div><br/></div><div><br/></div><div>import java.util.UUID;</div><div><br/></div><div><br/></div><div>public class UUIDUtils {</div><div><br/></div><div>    <b>public static String uuid(){</b></div><div><b>        return UUID.randomUUID().toString().replace(&quot;-&quot;,&quot;&quot;);</b></div><div><b>    }</b></div><div>}</div></div><div><br/></div><div>2）编写一个MiaoShaUserKey类，设置token的过期时间为TOKEN_EMPIRE和prefix为token</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.imooc.miaosha.redis;</div><div><br/></div><div><br/></div><div>public class <b><font style="font-size: 10pt;">MiaoShaUserKey</font></b> extends BasePrefix{</div><div><br/></div><div><br/></div><div>    public static final int <b><font style="font-size: 10pt;">TOKEN_EMPIRE</font></b> = 3600 *24 * 2;</div><div><br/></div><div><br/></div><div>    public MiaoShaUserKey(String prefix){</div><div>        super(prefix);</div><div>    }</div><div><br/></div><div><br/></div><div>    public MiaoShaUserKey(int empire, String prefix){</div><div>        super(TOKEN_EMPIRE, prefix);</div><div>    }</div><div><br/></div><div><br/></div><div>    public static MiaoShaUserKey <b><font style="font-size: 10pt;">token</font></b> = new MiaoShaUserKey(<b><font style="font-size: 11pt;">TOKEN_EMPIRE, &quot;token&quot;</font></b>);</div><div>}</div></div><div><br/></div><div>3）改造MiaoShaUserService类的login方法，在登陆的时候随机生成token，存放在redis远程服务中。此外还要生成cookie，添加在响应里。以便下次访问的时候带着cookie来获取token，进而获取用户数据。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@Service<br/></div><div>public class <font style="font-size: 11pt;"><b>MiaoShaUserService</b></font> {</div><div>   <b><font style="font-size: 10pt;"> public static final String COOKIE_NAME_TOKEN = &quot;token&quot;;</font></b></div><div><br/></div><div>    @Autowired</div><div>    MiaoShaUserDAO miaoShaUserDAO;</div><div><br/></div><div>    @Autowired</div><div>    RedisService redisService;</div><div><br/></div><div>    public boolean <b><font style="font-size: 11pt;">login</font></b>(HttpServletResponse response, LoginVo loginVo){</div><div>        if (loginVo == null)</div><div>            throw new GlobalException(CodeMsg.SERVER_ERROR);</div><div><br/></div><div>        //检验手机号码是否正确</div><div>        MiaoShaUser miaoShaUser = miaoShaUserDAO.getUserById(Long.parseLong(loginVo.getMobile()));</div><div>        if (miaoShaUser == null)</div><div>            throw new GlobalException(CodeMsg.MOBILE_NOT_EXIST);</div><div><br/></div><div><br/></div><div>        //校验密码是否正确</div><div>        String dbpassword = miaoShaUser.getPassword();</div><div>        String salt = miaoShaUser.getSalt();</div><div>        String formPass = loginVo.getPassword();</div><div>        String calPass = MD5Util.formPassToDBPass(formPass, salt);</div><div>        if(!dbpassword.equals(calPass))</div><div>            throw new GlobalException(CodeMsg.PASSWORD_ERROR);</div><div><br/></div><div><span>    </span><span>    </span><br/></div><div>         <b><font style="font-size: 10pt;">String token = UUIDUtils.uuid();</font></b></div><div><b><font style="font-size: 10pt;"><span>    </span><span>    //这样前缀就是：MiaoShaUserKey:tkxxxx   值就是</span></font><font style="font-size: 10pt;">miaoShaUser的内容</font></b></div><div><b><font style="font-size: 10pt;">        redisService.set(MiaoShaUserKey.token, token, miaoShaUser);</font></b></div><div><b><font style="font-size: 10pt;"><br/></font></b></div><div><b><font style="font-size: 10pt;"><span>    </span><span>    //相当于也是K-V。K就是COOKIE_NAME_TOKEN，V就是token的值</span><br/></font></b></div><div><b><font style="font-size: 10pt;">        Cookie cookie = new Cookie(COOKIE_NAME_TOKEN, token);</font></b></div><div><b><font style="font-size: 10pt;">        cookie.setMaxAge(MiaoShaUserKey.token.empireSecond());</font></b></div><div><b><font style="font-size: 10pt;">        cookie.setPath(&quot;/&quot;);</font></b></div><div><b><font style="font-size: 10pt;">        response.addCookie(cookie);</font></b></div><div><b><font style="font-size: 10pt;">        return true;</font></b></div><div>    }</div><div><br/></div><div><span>    //这一部分是第六步用到的，就是登陆进来，获取请求中携带的token，然后从redis中根据token取出来用户</span><br/></div><div>    public MiaoShaUser getByToken(String token) {</div><div>        if (StringUtils.isEmpty(token)){</div><div>            return null;</div><div>        }</div><div>        return redisService.get(MiaoShaUserKey.token, token, MiaoShaUser.class);</div><div>    }</div><div>}</div></div><div><br/></div><div>4）改造login.html页面，使得一旦验证成功就跳转到商品列表页面</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>success:function(data){</div><div>   layer.closeAll();</div><div>   if(data.code == 0){</div><div>      layer.msg(&quot;成功&quot;);</div><div>      <b><font style="font-size: 10pt;">window.location.href=&quot;/goods/to_list&quot;;</font></b></div><div>   }else{</div><div>      layer.msg(data.msg);</div><div>   }</div><div>},</div></div><div><br/></div><div>5）编写goods_list.html页面</div><div><br/></div><div>6）编写一个GoodsController类，来专门处理商品类的请求</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.imooc.miaosha.controller;</div><div><br/></div><div><br/></div><div>import com.imooc.miaosha.domain.MiaoShaUser;</div><div>import com.imooc.miaosha.redis.KeyPrefix;</div><div>import com.imooc.miaosha.redis.RedisService;</div><div>import com.imooc.miaosha.result.Result;</div><div>import com.imooc.miaosha.service.MiaoShaUserService;</div><div>import com.imooc.miaosha.service.UserService;</div><div>import com.imooc.miaosha.vo.LoginVo;</div><div>import org.slf4j.Logger;</div><div>import org.slf4j.LoggerFactory;</div><div>import org.springframework.beans.factory.annotation.Autowired;</div><div>import org.springframework.stereotype.Controller;</div><div>import org.springframework.ui.Model;</div><div>import org.springframework.web.bind.annotation.CookieValue;</div><div>import org.springframework.web.bind.annotation.RequestMapping;</div><div>import org.springframework.web.bind.annotation.RequestParam;</div><div>import org.springframework.web.bind.annotation.ResponseBody;</div><div>import org.thymeleaf.util.StringUtils;</div><div><br/></div><div><br/></div><div>import javax.servlet.http.HttpServletResponse;</div><div>import javax.validation.Valid;</div><div><br/></div><div><br/></div><div>@Controller</div><div>@RequestMapping(&quot;<b>/goods</b>&quot;)</div><div>public class <b><font style="font-size: 10pt;">GoodsController</font></b> {</div><div><br/></div><div><br/></div><div>    @Autowired</div><div>    UserService userService;</div><div><br/></div><div><br/></div><div>    @Autowired</div><div>    MiaoShaUserService miaoShaUserService;</div><div><br/></div><div><br/></div><div>    @Autowired</div><div>    RedisService redisService;</div><div><br/></div><div><br/></div><div>    @RequestMapping(&quot;<b>/to_list</b>&quot;)</div><div>    public String toList(Model model,</div><div><span>    </span><span>    </span><span>    //一开始设置的就是K为</span>COOKIE_NAME_TOKEN，V为token，因此通过这种方式取出请求中携带的token<br/></div><div>            <b><font style="font-size: 10pt;">@CookieValue(value = MiaoShaUserService.COOKIE_NAME_TOKEN, <font color="#E30000">required = false</font>) String cookieToToken,</font></b></div><div><b><font style="font-size: 10pt;">            @RequestParam(value = MiaoShaUserService.COOKIE_NAME_TOKEN, <font color="#E30000">required = false</font>) String param</font></b>){</div><div>        if (StringUtils.isEmpty(cookieToToken) &amp;&amp; StringUtils.isEmpty(param)){</div><div>            return &quot;login&quot;;</div><div>        }</div><div>        String token = StringUtils.isEmpty(param)?cookieToToken:param;</div><div>        MiaoShaUser userByToken = miaoShaUserService.getByToken(token);</div><div>        model.addAttribute(&quot;user&quot;, userByToken);</div><div>        return &quot;goods_list&quot;;</div><div>    }</div><div>}</div></div><div><br/></div><div>新学到的</div><div>    StringUtils.isEmpty、Pattern、Matcher、log</div><div><br/></div><div>还要学的：</div><div>    html、css、js、jquery、ajax、vo、log、Pattern、StringUtils、Matcher、</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 