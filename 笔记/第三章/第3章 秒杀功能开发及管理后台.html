<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601967 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 14pt;
    }
  </style>
</head>
<body>
<a name="2390"/>

<div>
<span><div><div><span style="font-size: 24pt; font-weight: bold;">一、商品列表页</span></div><hr/><div>1）商品列表页需要展示商品信息和秒杀信息。因此写一个GoodsVo类，继承Goods类并具有部分秒杀商品信息，比如秒杀价格，库存和秒杀开始时间，结束时间</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.imooc.miaosha.vo;</div><div><br/></div><div><br/></div><div>import com.imooc.miaosha.domain.Goods;</div><div><br/></div><div><br/></div><div>import java.util.Date;</div><div><br/></div><div><br/></div><div>public class GoodsVo extends Goods {</div><div>    private Double miaoshaPrice;</div><div>    private Integer stockCount;</div><div>    private Date startDate;</div><div>    private Date endDate;</div><div><br/></div><div><br/></div><div>    public Double getMiaoshaPrice() {</div><div>        return miaoshaPrice;</div><div>    }</div><div><br/></div><div><br/></div><div>    public void setMiaoshaPrice(Double miaoshaPrice) {</div><div>        this.miaoshaPrice = miaoshaPrice;</div><div>    }</div><div><br/></div><div><br/></div><div>    public Integer getStockCount() {</div><div>        return stockCount;</div><div>    }</div><div><br/></div><div><br/></div><div>    public void setStockCount(Integer stockCount) {</div><div>        this.stockCount = stockCount;</div><div>    }</div><div><br/></div><div><br/></div><div>    public Date getStartDate() {</div><div>        return startDate;</div><div>    }</div><div><br/></div><div><br/></div><div>    public void setStartDate(Date startDate) {</div><div>        this.startDate = startDate;</div><div>    }</div><div><br/></div><div><br/></div><div>    public Date getEndDate() {</div><div>        return endDate;</div><div>    }</div><div><br/></div><div><br/></div><div>    public void setEndDate(Date endDate) {</div><div>        this.endDate = endDate;</div><div>    }</div><div>}</div></div><div><br/></div><div>2）编写DAO层</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.imooc.miaosha.dao;</div><div><br/></div><div><br/></div><div>import com.imooc.miaosha.vo.GoodsVo;</div><div>import org.apache.ibatis.annotations.Mapper;</div><div>import org.apache.ibatis.annotations.Select;</div><div><br/></div><div><br/></div><div>import java.util.List;</div><div><br/></div><div><br/></div><div>@Mapper</div><div>public interface GoodsDAO {</div><div><br/></div><div><br/></div><div>    @Select(&quot;select g.*, mg.stock_count, mg.start_date, mg.end_date,mg.miaosha_price from goods g left join miaosha_goods mg on g.id = mg.id&quot;)</div><div>    public List&lt;GoodsVo&gt; listGoodsVo();</div><div>}</div></div><div><br/></div><div>3）编写Service层</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.imooc.miaosha.service;</div><div><br/></div><div><br/></div><div>import com.imooc.miaosha.dao.GoodsDAO;</div><div>import com.imooc.miaosha.vo.GoodsVo;</div><div>import org.springframework.beans.factory.annotation.Autowired;</div><div>import org.springframework.stereotype.Service;</div><div><br/></div><div><br/></div><div>import java.util.List;</div><div><br/></div><div><br/></div><div>@Service</div><div>public class GoodsService {</div><div><br/></div><div><br/></div><div>    @Autowired</div><div>    GoodsDAO goodsDAO;</div><div><br/></div><div><br/></div><div>    public List&lt;GoodsVo&gt; listGoodsVo(){</div><div>        return goodsDAO.listGoodsVo();</div><div>    }</div><div>}</div></div><div><br/></div><div>4）修改Controller层内容，加入查找到的秒杀商品信息</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.imooc.miaosha.controller;</div><div><br/></div><div>import com.imooc.miaosha.domain.MiaoShaUser;</div><div>import com.imooc.miaosha.redis.KeyPrefix;</div><div>import com.imooc.miaosha.redis.RedisService;</div><div>import com.imooc.miaosha.result.Result;</div><div>import com.imooc.miaosha.service.GoodsService;</div><div>import com.imooc.miaosha.service.MiaoShaUserService;</div><div>import com.imooc.miaosha.service.UserService;</div><div>import com.imooc.miaosha.vo.GoodsVo;</div><div>import com.imooc.miaosha.vo.LoginVo;</div><div>import org.slf4j.Logger;</div><div>import org.slf4j.LoggerFactory;</div><div>import org.springframework.beans.factory.annotation.Autowired;</div><div>import org.springframework.stereotype.Controller;</div><div>import org.springframework.ui.Model;</div><div>import org.springframework.web.bind.annotation.CookieValue;</div><div>import org.springframework.web.bind.annotation.RequestMapping;</div><div>import org.springframework.web.bind.annotation.RequestParam;</div><div>import org.springframework.web.bind.annotation.ResponseBody;</div><div>import org.thymeleaf.util.StringUtils;</div><div><br/></div><div><br/></div><div>import javax.servlet.http.HttpServletResponse;</div><div>import javax.validation.Valid;</div><div>import java.util.List;</div><div><br/></div><div><br/></div><div>@Controller</div><div>@RequestMapping(&quot;/goods&quot;)</div><div>public class GoodsController {</div><div><br/></div><div><br/></div><div>    @Autowired</div><div>    UserService userService;</div><div><br/></div><div><br/></div><div>    @Autowired</div><div>    MiaoShaUserService miaoShaUserService;</div><div><br/></div><div><br/></div><div>    @Autowired</div><div>    RedisService redisService;</div><div><br/></div><div><br/></div><div>    @Autowired</div><div>    GoodsService goodsService;</div><div><br/></div><div><br/></div><div>    @RequestMapping(&quot;/to_list&quot;)</div><div>    public String toList(Model model, MiaoShaUser user){</div><div>        model.addAttribute(&quot;user&quot;, user);</div><div>        List&lt;GoodsVo&gt; goodsList = goodsService.listGoodsVo();</div><div>        model.addAttribute(&quot;goodsList&quot;, goodsList);</div><div>        return &quot;goods_list&quot;;</div><div>    }</div><div>}</div></div><div><br/></div><div><br/></div><div><span style="font-size: 24pt; font-weight: bold;">二、商品详情页</span></div><hr/><div>1）Controller层方法修改</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@RequestMapping(&quot;/to_detail/{goodsId}&quot;)</div><div>public String toDetail(Model model, MiaoShaUser user,</div><div>                       @PathVariable(&quot;goodsId&quot;) long goodsId){</div><div><br/></div><div><br/></div><div>    model.addAttribute(&quot;user&quot;, user);</div><div><br/></div><div><br/></div><div>    GoodsVo goods = goodsService.getGoodsByGoodsId(goodsId);</div><div>    model.addAttribute(&quot;goods&quot;, goods);</div><div><br/></div><div><br/></div><div>    long startAt = goods.getStartDate().getTime();</div><div>    long endAt = goods.getEndDate().getTime();</div><div>    long now = System.currentTimeMillis();</div><div><br/></div><div><br/></div><div>    int miaoshaStatus = 0; //秒杀状态，0为未开始，1为进行中，2为已结束</div><div>    int remainSeconds = 0; //秒杀倒计时。未开始为计算时间，进行时为0，已结束为-1</div><div>    if(now &lt; startAt ) {//秒杀还没开始，倒计时</div><div>        miaoshaStatus = 0;</div><div>        remainSeconds = (int)((startAt - now )/1000);</div><div>    }else  if(now &gt; endAt){//秒杀已经结束</div><div>        miaoshaStatus = 2;</div><div>        remainSeconds = -1;</div><div>    }else {//秒杀进行中</div><div>        miaoshaStatus = 1;</div><div>        remainSeconds = 0;</div><div>    }</div><div>    model.addAttribute(&quot;miaoshaStatus&quot;, miaoshaStatus);</div><div>    model.addAttribute(&quot;remainSeconds&quot;, remainSeconds);</div><div>    return &quot;goods_detail&quot;;</div><div>}</div></div><div><br/></div><div>2）Service层中添加相应的方法</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>public GoodsVo getGoodsByGoodsId(Long goodsId) {</div><div>    return goodsDAO.getGoodsByGoodsId(goodsId);</div><div>}</div></div><div><br/></div><div>3）DAO层中添加相应的方法</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@Select(&quot;select g.*, mg.stock_count, mg.start_date, mg.end_date,mg.miaosha_price from goods g left join miaosha_goods mg on g.id = mg.id where g.id = #{goodsId}&quot;)</div><div>GoodsVo getGoodsByGoodsId(Long goodsId);</div></div><div><br/></div><div><br/></div><div><span style="font-size: 24pt; font-weight: bold;">三、秒杀功能实现</span></div><hr/><div><br/></div><div><img src="第3章 秒杀功能开发及管理后台_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@SelectKey(keyColumn=&quot;id&quot;, keyProperty=&quot;id&quot;, resultType=long.class, before=false, statement=&quot;select last_insert_id()&quot;)</div><div><br/></div><div>* statement是要运行的SQL语句，它的返回值通过resultType来指定</div><div>* before表示查询语句statement运行的时机</div><div>* keyProperty表示查询结果赋值给代码中的哪个对象，keyColumn表示将查询结果赋值给数据库表中哪一列</div><div>* keyProperty和keyColumn都不是必需的，有没有都可以</div><div>* before=true，插入之前进行查询，可以将查询结果赋给keyProperty和keyColumn，赋给keyColumn相当于更改数据库</div><div>* befaore=false，先插入，再查询，这时只能将结果赋给keyProperty</div><div>* 赋值给keyProperty用来“读”数据库，赋值给keyColumn用来写数据库</div><div>* selectKey的两大作用：1、生成主键；2、获取刚刚插入数据的主键。</div><div>* 使用selectKey，并且使用MySQL的last_insert_id()函数时，before必为false，也就是说必须先插入然后执行last_insert_id()才能获得刚刚插入数据的ID。</div></div><div><span><font style="font-size: 14pt;"><br/></font></span></div><br/></div><div><br/></div></span>
</div></body></html> 